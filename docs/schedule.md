# Расписание

Просто так вводить расписание в базу данных для каждой группы - тупо? Естественно! В этом "гайде" я постараюсь подробно расписать использование API вебсайта [https://kai.ru/main](https://kai.ru/main) для получения расписания группы.

### Содержание

- [Основы использования API](#Основы-использования-API)
  - [Необходимые запросы](#Необходимые-запросы)
- [API КНИТУ-КАИ](#API-КНИТУ-КАИ)
  - [Запрос для получения ID группы](#Запрос-для-получения-ID-группы)
  - [Получение объекта расписания](#Получение-объекта-расписания)
  - [Подробно о JSON объекте](#Подробно-о-JSON-объекте)
- [Конец](#Конец)

# Основы использования API

Изучая другие проектные работы ([Telegram Bot](https://github.com/L11R/KnituKaiBot-telegram), [Vkontakte Bot](https://github.com/DobryninIlya/botkai)), я заметил, что каждый бот использует эндпоинт `https://kai.ru/raspisanie` для нахождения расписания. Таким образом, я приступил к работе с API КНИТУ-КАИ.

## Необходимые запросы

Для создания бота я воспользовался сторонним модулем отправки запросов API - [`axios`](https://axios-http.com/). Как ни странно, но если вы захотите использовать этот модуль, то вам понадобиться изменить хедер `User-Agent` на любой другой т.к. я столкнулся с проблемой - при отправке запроса с нативного хедера `axios` сокет отказывается получать информацию об объекте/запросе:
```json
{
    "headers": {
        "User-Agent": "Mozilla/5.0"
    }
}
```

Для нахождения расписания нам понадобится 2 запроса API:

- Запрос для узнавания ID группы по её названию
- Сам запрос для получения объекта расписания

# API КНИТУ-КАИ

По сравнению с [edu.tatar.ru](https://edu.tatar.ru), сайт КНИТУ-КАИ имеет открытый доступ к их API. То есть у тебя есть возможность воспользоваться API КНИТУ-КАИ в своих проектах прямо сейчас без наличия специальных API ключей и подобной приблуды.

## Запрос для получения ID группы

Для получения ID нам понадобится сделать GET запрос на [`https://kai.ru/raspisanie`](https://kai.ru/raspisanie). Помимо самого запроса нам нужны параметры (те которые после "?" в строке задаются):

```json
{
    "p_p_id": "pubStudentSchedule_WAR_publicStudentSchedule10",
    "p_p_lifecycle": 2,
    "p_p_resource_id": "getGroupsURL",
    "query": "имя группы (например: 4131)"
}
```

Таким образом мы можем сделать запрос:

```url
https://kai.ru/raspisanie?p_p_id=pubStudentSchedule_WAR_publicStudentSchedule10&p_p_lifecycle=2&p_p_resource_id=getGroupsURL&query=имя группы
```
> [пример](https://kai.ru/raspisanie?p_p_id=pubStudentSchedule_WAR_publicStudentSchedule10&p_p_lifecycle=2&p_p_resource_id=getGroupsURL&query=4131)

После запроса мы получаем массив состоящий из объектов-групп. Он может быть как и пустым, так и состоять из нескольких объектов в зависимости от имени группы: сервер может найти несколько групп начинающихся на определённое имя группы или может ничего не найти:

```json
[
    {
        "id": 23653,
        "group": "4131",
        "forma": "4toto"
    }
]
```

В ответе нам нужен ключ id для самого объекта расписания!

## Получение объекта расписания

Как и с ID группы нам нужно сделать запрос на [`https://kai.ru/raspisanie`](https://kai.ru/raspisanie), но на этот раз он должен быть POST. В параметрах нам нужен иной `p_p_resource_id`:

```json
{
    "p_p_id": "pubStudentSchedule_WAR_publicStudentSchedule10",
    "p_p_lifecycle": 2,
    "p_p_resource_id": "schedule"
}
```

Запрос должен быть иметь тип контента: `application/x-www-form-urlencoded` и иметь ключ data:

```json
{
    "data": "groupId=айди группы"
}
```

После чего мы получаем объект расписания:

```json
{
    "2": [
        {
            "prepodNameEnc": "%D0%9A%D0%90%D0%A0%D0%9F%D0%95%D0%95%D0%92%D0%90+%D0%A2%D0%90%D0%A2%D0%AC%D0%AF%D0%9D%D0%90+%D0%90%D0%9B%D0%95%D0%9A%D0%A1%D0%90%D0%9D%D0%94%D0%A0%D0%9E%D0%92%D0%9D%D0%90++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++",
            "dayDate": " ",
            "audNum": "210                                                                                                 ",
            "disciplName": "Литература",
            "buildNum": "7                                                 ",
            "orgUnitName": "Учебный отдел",
            "dayTime": "08:00     ",
            "dayNum": "2",
            "potok": "",
            "prepodName": "КАРПЕЕВА ТАТЬЯНА АЛЕКСАНДРОВНА                                                                      ",
            "disciplNum": "3833",
            "orgUnitId": "1264961",
            "prepodLogin": "takarpeeva",
            "disciplType": "лек       ",
            "disciplNameEnc": "%D0%9B%D0%B8%D1%82%D0%B5%D1%80%D0%B0%D1%82%D1%83%D1%80%D0%B0"
        },
        {
            "prepodNameEnc": "%D0%93%D0%90%D0%A0%D0%95%D0%95%D0%92%D0%90+%D0%97%D0%A3%D0%9B%D0%AC%D0%A4%D0%98%D0%AF+%D0%92%D0%90%D0%9B%D0%98%D0%90%D0%A5%D0%9C%D0%95%D0%A2%D0%9E%D0%92%D0%9D%D0%90+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++",
            "dayDate": " ",
            "audNum": "531                                                                                                 ",
            "disciplName": "История(общий курс)",
            "buildNum": "7                                                 ",
            "orgUnitName": "Учебный отдел",
            "dayTime": "09:40     ",
            "dayNum": "2",
            "potok": "",
            "prepodName": "ГАРЕЕВА ЗУЛЬФИЯ ВАЛИАХМЕТОВНА                                                                       ",
            "disciplNum": "4551",
            "orgUnitId": "1264961",
            "prepodLogin": "zvgareeva",
            "disciplType": "лек       ",
            "disciplNameEnc": "%D0%98%D1%81%D1%82%D0%BE%D1%80%D0%B8%D1%8F%28%D0%BE%D0%B1%D1%89%D0%B8%D0%B9+%D0%BA%D1%83%D1%80%D1%81%29"
        },
        {
            "prepodNameEnc": "%D0%A1%D0%9E%D0%9B%D0%9E%D0%92%D0%AC%D0%95%D0%92+%D0%92%D0%9B%D0%90%D0%94%D0%98%D0%9C%D0%98%D0%A0+%D0%92%D0%9B%D0%90%D0%94%D0%98%D0%9C%D0%98%D0%A0%D0%9E%D0%92%D0%98%D0%A7++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++",
            "dayDate": " ",
            "audNum": "125                                                                                                 ",
            "disciplName": "Математика (общий курс)",
            "buildNum": "7                                                 ",
            "orgUnitName": "Учебный отдел",
            "dayTime": "11:20     ",
            "dayNum": "2",
            "potok": "",
            "prepodName": "СОЛОВЬЕВ ВЛАДИМИР ВЛАДИМИРОВИЧ                                                                      ",
            "disciplNum": "816",
            "orgUnitId": "1264961",
            "prepodLogin": "VVSolovev",
            "disciplType": "лек       ",
            "disciplNameEnc": "%D0%9C%D0%B0%D1%82%D0%B5%D0%BC%D0%B0%D1%82%D0%B8%D0%BA%D0%B0+%28%D0%BE%D0%B1%D1%89%D0%B8%D0%B9+%D0%BA%D1%83%D1%80%D1%81%29"
        }
    ]
}
```

## Подробно о JSON объекте

Объект состоит из 6 массивов ("1", "2", "3", "4", "5", "6"). Массивы же состоят из объектов-пар в том порядке в котором они идут по времени.

В объектах-парах можно узнать:
- В чётную ли неделю (`dayDate`, может иметь значения: `""`, `"чет"`, `"неч"`)
- Номер аудитории (`audNum`)
- Название пары (`disciplName`)
- Номер здания (`buildNum`)
- Кафедру (`orgUnitName`)
- Время начала (`dayTime`)
- Номер дня (`dayNum`, одно и то же, что и название массива)
- ФИО преподователя (`prepodName`)
- Номер пары (`disciplNum`)
- Айди кафедры (`orgUnitId`)
- Логин преподователя (`prepodLogin`)
- Тип пары (`disciplType`, может иметь значения: `"лек"`, `"пр"`)

В нём, стоит упомянуть, криво написаны значения ключей. Они могут быть пустыми или иметь лишние пробелы в конце и в начале.

# Конец

Несмотря на то, что API КНИТУ-КАИ на этом не заканчивается, я выделил всё необходимое для тех, кто хочет добавить расписание КАИ в свой проект. Спасибо за внимание

> Для контрибуторов смотреть `/docs/contribute.md`. Буду очень рад если вы поможете с развитием проекта.
